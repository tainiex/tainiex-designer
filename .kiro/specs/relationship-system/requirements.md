# 关系系统重构 - 需求文档

## 1. 概述

### 1.1 目标
完善 Tainiex Designer 的关系管理系统，使其能够完整地创建、编辑、显示和验证表之间的关系。

### 1.2 背景
当前系统已有基础的关系模型和 RelationshipTool，但缺少完整的关系创建向导、编辑界面和可视化增强。

### 1.3 范围
- ✅ 关系创建向导
- ✅ 关系编辑对话框
- ✅ 关系可视化增强
- ✅ 关系验证
- ❌ 多对多关系的中间表自动生成（后续版本）
- ❌ 关系的高级属性（如分区键）（后续版本）

## 2. 用户故事

### 2.1 作为数据库设计师，我想要创建表之间的关系

**场景**：
```
给定：我有两个表 "users" 和 "posts"
当：我使用关系工具从 posts 表拖拽到 users 表
那么：系统应该显示关系创建向导
并且：我可以选择关联的字段
并且：我可以设置关系类型（1:1, 1:N, N:M）
并且：我可以配置级联操作（CASCADE, SET NULL, RESTRICT）
```

**验收标准**：
1. 关系工具可以从源表拖拽到目标表
2. 显示关系创建向导对话框
3. 向导包含以下步骤：
   - 选择源表字段
   - 选择目标表字段
   - 选择关系类型
   - 配置级联规则
4. 创建成功后在画布上显示关系连线
5. 关系信息保存到 Schema

### 2.2 作为数据库设计师，我想要编辑已存在的关系

**场景**：
```
给定：画布上已有一个关系连线
当：我双击该关系连线
那么：系统应该显示关系编辑对话框
并且：我可以修改关系类型
并且：我可以修改关联字段
并且：我可以修改级联规则
```

**验收标准**：
1. 双击关系连线打开编辑对话框
2. 对话框显示当前关系的所有属性
3. 可以修改所有可编辑属性
4. 保存后立即更新画布显示
5. 取消后不改变原有关系

### 2.3 作为数据库设计师，我想要看到不同类型的关系有不同的视觉表现

**场景**：
```
给定：画布上有多个不同类型的关系
当：我查看画布
那么：1:1 关系应该显示为直线，两端都有单箭头
并且：1:N 关系应该显示为直线，目标端有单箭头，源端有多箭头
并且：N:M 关系应该显示为直线，两端都有多箭头
并且：关系连线应该显示关系名称或字段名称
```

**验收标准**：
1. 不同关系类型有不同的视觉样式
2. 箭头样式正确表示关系基数
3. 连线上显示有用的标签信息
4. 鼠标悬停时高亮显示关系
5. 选中关系时显示控制点

### 2.4 作为数据库设计师，我想要系统验证关系的正确性

**场景**：
```
给定：我创建了一个关系
当：系统验证该关系
那么：应该检查源表和目标表是否存在
并且：应该检查关联字段是否存在
并且：应该检查字段类型是否兼容
并且：应该检查是否存在循环依赖
并且：应该警告孤立表
```

**验收标准**：
1. 创建关系时自动验证
2. 验证失败时显示错误信息
3. 验证警告时显示警告信息
4. 提供修复建议
5. 验证结果显示在验证面板

## 3. 功能需求

### 3.1 关系创建向导

#### 3.1.1 向导界面
- **步骤 1：选择表**
  - 显示源表和目标表名称
  - 不可编辑（已通过拖拽确定）
  
- **步骤 2：选择字段**
  - 源表字段下拉列表
  - 目标表字段下拉列表
  - 显示字段类型
  - 高亮显示主键字段
  
- **步骤 3：关系类型**
  - 单选按钮：1:1, 1:N, N:M
  - 每种类型的说明文字
  - 图示说明
  
- **步骤 4：级联规则**
  - ON DELETE 下拉列表：CASCADE, SET NULL, RESTRICT, NO ACTION
  - ON UPDATE 下拉列表：CASCADE, SET NULL, RESTRICT, NO ACTION
  - 每个选项的说明文字

#### 3.1.2 向导行为
- 支持"上一步"、"下一步"、"完成"、"取消"按钮
- 验证每一步的输入
- 显示验证错误
- 完成时创建关系并关闭向导

### 3.2 关系编辑对话框

#### 3.2.1 对话框内容
- 关系名称（可选）
- 源表和目标表（只读）
- 源字段下拉列表
- 目标字段下拉列表
- 关系类型单选按钮
- ON DELETE 下拉列表
- ON UPDATE 下拉列表
- 注释文本框

#### 3.2.2 对话框行为
- 显示当前关系的所有属性
- 实时验证输入
- 保存按钮（验证通过后启用）
- 取消按钮
- 删除按钮（确认后删除关系）

### 3.3 关系可视化

#### 3.3.1 连线样式
- **1:1 关系**
  - 直线或贝塞尔曲线
  - 两端单箭头：`○──────○`
  - 颜色：蓝色 (#4a90e2)
  
- **1:N 关系**
  - 直线或贝塞尔曲线
  - 源端单箭头，目标端多箭头：`○──────<`
  - 颜色：绿色 (#52c41a)
  
- **N:M 关系**
  - 直线或贝塞尔曲线
  - 两端多箭头：`<──────>`
  - 颜色：橙色 (#fa8c16)

#### 3.3.2 标签显示
- 显示位置：连线中点
- 显示内容：关系名称或 `source_field → target_field`
- 字体：12px sans-serif
- 背景：白色半透明
- 边框：1px 实线

#### 3.3.3 交互状态
- **正常状态**：默认颜色，线宽 2px
- **悬停状态**：高亮颜色，线宽 3px，显示工具提示
- **选中状态**：高亮颜色，线宽 3px，显示控制点
- **错误状态**：红色虚线，显示错误图标

### 3.4 关系验证

#### 3.4.1 验证规则

**错误级别**：
1. **表存在性**
   - 源表必须存在
   - 目标表必须存在
   
2. **字段存在性**
   - 源字段必须存在于源表
   - 目标字段必须存在于目标表
   
3. **类型兼容性**
   - 源字段和目标字段类型必须兼容
   - 兼容规则：
     - 相同类型
     - 数值类型之间（INT, BIGINT, DECIMAL）
     - 字符类型之间（VARCHAR, CHAR, TEXT）

**警告级别**：
1. **主键建议**
   - 目标字段应该是主键或唯一键
   
2. **索引建议**
   - 源字段应该有索引（外键字段）
   
3. **命名规范**
   - 外键字段建议命名为 `{table}_id`
   
4. **循环依赖**
   - 检测并警告循环依赖

#### 3.4.2 验证时机
- 创建关系时
- 编辑关系时
- 修改表结构时
- 手动触发验证时

#### 3.4.3 验证结果展示
- 验证面板显示所有错误和警告
- 错误项显示红色图标
- 警告项显示黄色图标
- 点击错误/警告定位到相关对象
- 提供快速修复建议

## 4. 非功能需求

### 4.1 性能
- 关系创建响应时间 < 100ms
- 关系编辑响应时间 < 100ms
- 验证执行时间 < 200ms
- 大量关系（100+）渲染帧率 > 30fps

### 4.2 可用性
- 向导步骤清晰，易于理解
- 错误信息明确，提供修复建议
- 支持键盘导航
- 支持快捷键操作

### 4.3 可维护性
- 关系逻辑与 UI 分离
- 验证规则可配置
- 样式可主题化
- 代码有完整注释

### 4.4 兼容性
- 支持所有主流浏览器
- 支持 Windows/macOS/Linux
- 支持高 DPI 显示

## 5. 技术约束

### 5.1 技术栈
- TypeScript 5.6+
- Canvas 2D API
- 现有的分层渲染架构
- 现有的数据模型

### 5.2 依赖
- 现有的 Relationship 模型
- 现有的 RelationshipLayer
- 现有的 RelationshipTool
- 现有的 Schema 管理

### 5.3 限制
- 不使用第三方 UI 框架
- 保持轻量级
- 避免过度设计

## 6. 数据模型

### 6.1 Relationship 模型扩展

```typescript
class Relationship {
  id: string;
  name?: string;  // 新增：关系名称
  type: RelationType;  // 'one-to-one' | 'one-to-many' | 'many-to-many'
  sourceTableId: string;
  targetTableId: string;
  sourceColumnId: string;
  targetColumnId: string;
  onDelete?: CascadeAction;  // 'CASCADE' | 'SET NULL' | 'RESTRICT' | 'NO ACTION'
  onUpdate?: CascadeAction;  // 'CASCADE' | 'SET NULL' | 'RESTRICT' | 'NO ACTION'
  comment?: string;  // 新增：注释
  
  // 验证方法
  validate(schema: Schema): ValidationResult;
}
```

### 6.2 ValidationResult 接口

```typescript
interface ValidationResult {
  valid: boolean;
  errors: ValidationError[];
  warnings: ValidationWarning[];
}

interface ValidationError {
  code: string;
  message: string;
  field?: string;
  suggestion?: string;
}

interface ValidationWarning {
  code: string;
  message: string;
  field?: string;
  suggestion?: string;
}
```

## 7. UI 组件

### 7.1 RelationshipWizard 组件
- 多步骤向导对话框
- 步骤指示器
- 表单验证
- 导航按钮

### 7.2 RelationshipEditor 组件
- 单页对话框
- 表单字段
- 实时验证
- 操作按钮

### 7.3 RelationshipLabel 组件
- Canvas 上的标签
- 背景和边框
- 文字渲染

### 7.4 ValidationPanel 组件
- 错误和警告列表
- 图标和颜色
- 点击定位
- 修复建议

## 8. 测试需求

### 8.1 单元测试
- Relationship 模型测试
- 验证规则测试
- 工具方法测试

### 8.2 集成测试
- 关系创建流程测试
- 关系编辑流程测试
- 验证流程测试

### 8.3 E2E 测试
- 完整的用户操作流程
- 跨平台测试

### 8.4 性能测试
- 大量关系渲染测试
- 验证性能测试

## 9. 交付物

### 9.1 代码
- [ ] Relationship 模型扩展
- [ ] RelationshipWizard 组件
- [ ] RelationshipEditor 组件
- [ ] RelationshipLayer 增强
- [ ] RelationshipTool 增强
- [ ] 验证引擎
- [ ] ValidationPanel 组件

### 9.2 文档
- [ ] API 文档
- [ ] 用户指南
- [ ] 测试报告

### 9.3 测试
- [ ] 单元测试（覆盖率 > 70%）
- [ ] 集成测试
- [ ] E2E 测试

## 10. 时间估算

| 任务 | 估算 | 依赖 |
|------|------|------|
| Relationship 模型扩展 | 0.5 天 | - |
| 验证引擎实现 | 1 天 | Relationship 模型 |
| RelationshipWizard 组件 | 1.5 天 | Relationship 模型 |
| RelationshipEditor 组件 | 1 天 | Relationship 模型 |
| RelationshipLayer 增强 | 1 天 | Relationship 模型 |
| RelationshipTool 增强 | 0.5 天 | 所有组件 |
| ValidationPanel 组件 | 0.5 天 | 验证引擎 |
| 测试和文档 | 1 天 | 所有功能 |

**总计**：7 天

## 11. 风险和缓解

### 11.1 风险
1. **UI 复杂度**：向导和对话框可能比预期复杂
2. **性能问题**：大量关系渲染可能影响性能
3. **验证规则**：验证逻辑可能不够完善

### 11.2 缓解措施
1. 使用简单的 HTML 对话框，避免过度设计
2. 实现视口裁剪，只渲染可见关系
3. 迭代完善验证规则，先实现核心规则

## 12. 成功标准

- [ ] 用户可以通过向导创建关系
- [ ] 用户可以编辑已存在的关系
- [ ] 不同类型的关系有不同的视觉表现
- [ ] 系统能够验证关系的正确性
- [ ] 所有测试通过
- [ ] 文档完整
- [ ] 性能达标
